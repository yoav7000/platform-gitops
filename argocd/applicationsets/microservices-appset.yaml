apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: microservices-appset
spec:
  # goTemplate: true
  goTemplateOptions: ["missingkey=error"]
  generators:
    - merge:
        mergeKeys:
          - values.service_name
          - values.env_name
        generators:
          - matrix:
              generators:
                - git:
                    repoURL: https://github.com/yoav7000/platform-gitops.git
                    revision: main
                    files:
                      - path: environments/*/config.yaml
                    pathParamPrefix: env
                    values:
                      env_name: '{{ index .env.path.segments 1 }}'
                      namespace: "{{ .cluster.namespace }}"
                      cluster_name: "{{ .cluster.name }}"
                - git:
                    repoURL: https://github.com/yoav7000/platform-gitops.git
                    revision: main
                    files:
                      - path: services/*/chart-config.yaml
                    pathParamPrefix: app
                    values:
                      service_name: '{{ index .app.path.segments 1 }}'

          - git:
              repoURL: https://github.com/yoav7000/platform-gitops.git
              revision: main
              files:
                - path: services/*/*/*/values.yaml
              values:
                service_name: "{{index .app.path.segments 1}}"
                env_name: "{{index .app.path.segments 2}}"

    # - git:
    #     repoURL: https://github.com/yoav7000/platform-gitops.git
    #     revision: main
    #     files:
    #       - path: services/*/*/values.yaml

    

  template:
    metadata:
      name: '{{index .app.path.segments 1}}-{{.values.env_name}}'
    spec:
      project: '{{.values.env_name}}'
      sources:
        - repoURL: '{{ .chart.repoURL }}'
          targetRevision: '{{ .chart.targetRevision }}'
          path: '{{.chart.path}}'
          helm:
            valueFiles:
              - $values/services/{{index .app.path.segments 1}}/envs/{{.values.env_name}}/values.yaml
            ignoreMissingValueFiles: true
        - repoURL: https://github.com/yoav7000/platform-gitops.git
          targetRevision: main
          ref: values
      destination:
        name: '{{ .values.cluster_name }}'
        namespace: '{{ .values.namespace }}'
      syncPolicy:
        automated:
          prune: true
          selfHeal: true
        syncOptions:
          - CreateNamespace=true